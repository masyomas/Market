<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; text-align:center;}
header { background:#6c757d; color:#fff; padding:12px; font-size:22px;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px 0; border-top:1px solid #ddd; border-bottom:1px solid #ddd; }
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff; }
section { margin:10px auto; width:95%; max-width:600px;}
h2 { margin:10px 0; font-size:20px; }
.info-line { display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#555;}
.purchase { border:1px solid #ddd; border-radius:6px; margin:8px 0; padding:6px; display:flex; align-items:center;}
.purchase img { width:60px; height:60px; object-fit:cover; border-radius:4px; margin-left:10px;}
.purchase-details { text-align:right; flex:1;}
.purchase-details div { font-size:13px; margin:2px 0;}
button.cancelBtn { padding:4px 8px; font-size:12px; background:#dc3545; color:#fff; border:none; border-radius:4px; cursor:pointer;}
button.cancelBtn:hover { background:#a71d2a;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
</style>
</head>
<body>

<header>ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</header>

<nav>
  <a href="index.html">ğŸ›ï¸ Ø§Ù„Ù…ØªØ¬Ø±</a>
  <a href="register.html">ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ</a>
</nav>

<section>
  <h2 id="userName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
  <div class="info-line">
    <span id="userCode">Ø§Ù„ÙƒÙˆØ¯: ####</span>
    <span id="userBonus">Ø§Ù„Ø¨ÙˆÙ†Øµ: 0 Ø¬Ù†ÙŠÙ‡</span>
  </div>

  <div id="purchasesList"></div>
</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
let logged=JSON.parse(localStorage.getItem('loggedUser'));
if(!logged || logged.role!=="user") location.href="register.html";

let users=JSON.parse(localStorage.getItem('users')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
let bonusPercent=parseFloat(localStorage.getItem('bonusPercent')) || 1;

let user=users.find(u=>u.phone===logged.phone && u.code===logged.code);
if(!user){ alert("âš ï¸ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±Ù"); location.href="register.html"; }

// Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯
document.getElementById('userName').textContent=user.name;
document.getElementById('userCode').textContent="Ø§Ù„ÙƒÙˆØ¯: "+user.code;

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙˆÙ†Øµ
let userPurchases=purchases.filter(p=>p.phone===user.phone);
let total=0;
userPurchases.forEach(p=>{ total+=parseFloat(p.price)||0; });
let bonus=Math.round((total * bonusPercent) / 100);
document.getElementById('userBonus').textContent="Ø§Ù„Ø¨ÙˆÙ†Øµ: "+bonus+" Ø¬Ù†ÙŠÙ‡";

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
let html="";
userPurchases.forEach(p=>{
  let timeDiff=(Date.now()-p.timestamp)/(1000*60*60); // ÙØ±Ù‚ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª
  let canCancel = timeDiff<6;
  html+=`
  <div class="purchase">
    <img src="${p.image||'pictures/empty.jpg'}" alt="">
    <div class="purchase-details">
      <div><b>${p.name}</b></div>
      <div>Ø§Ù„Ø³Ø¹Ø±: ${p.price} Ø¬Ù†ÙŠÙ‡</div>
      <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡: ${new Date(p.timestamp).toLocaleString('ar-EG')}</div>
    </div>
    ${canCancel? `<button class="cancelBtn" onclick="cancelPurchase(${p.timestamp})">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
  </div>`;
});
document.getElementById('purchasesList').innerHTML=html;

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡
function cancelPurchase(ts){
  if(confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ØŸ")){
    purchases=purchases.filter(p=>p.timestamp!==ts);
    localStorage.setItem('purchases', JSON.stringify(purchases));
    alert("âœ… ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡");
    location.reload();
  }
}
</script>

</body>
</html>
