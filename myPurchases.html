<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; text-align:center;}
header { background:#6c757d; color:#fff; padding:12px; font-size:22px;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px 0; border-top:1px solid #ddd; border-bottom:1px solid #ddd; }
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff; }
section { margin:10px auto; width:95%; max-width:800px;}
.top-info { margin:10px 0; font-size:16px; font-weight:bold; }
.sub-info { display:flex; justify-content:space-between; font-size:14px; color:#333; margin-bottom:10px; }
.item { border:1px solid #ddd; border-radius:6px; margin:5px 0; padding:8px; text-align:right;}
.item img { width:80px; height:80px; object-fit:cover; border-radius:4px; float:right; margin-left:8px;}
.item-details { overflow:hidden; }
button.cancelBtn { background:#dc3545; color:#fff; border:none; padding:4px 8px; font-size:13px; border-radius:4px; cursor:pointer; margin-top:4px;}
button.cancelBtn:hover { background:#c82333;}
.total { font-size:15px; font-weight:bold; margin-top:10px; }
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px; clear:both;}
.clearfix::after {content:""; clear:both; display:table;}
</style>
</head>
<body>

<header>ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</header>

<nav>
  <a href="index.html">ğŸ  Ø§Ù„Ù…ØªØ¬Ø±</a>
  <a href="myPurchases.html">ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</a>
  <a href="register.html">ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ</a>
</nav>

<section>
  <div class="top-info" id="userName">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
  <div class="sub-info">
    <span id="userCode">ğŸ§¾ Ø§Ù„ÙƒÙˆØ¯: </span>
    <span id="userBonus">ğŸ Ø§Ù„Ø¨ÙˆÙ†Øµ: </span>
  </div>
  <div id="purchasesContainer"></div>
  <div class="total" id="totalPaid">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬Ù†ÙŠÙ‡</div>
</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let logged=JSON.parse(localStorage.getItem('loggedUser'));
let users=JSON.parse(localStorage.getItem('users')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
let bonusPercent=parseFloat(localStorage.getItem('bonusPercent'))||1;

if(!logged || logged.role!=="user") {
  alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
  location.href="register.html";
}

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let user=users.find(u=>u.phone===logged.phone && u.code===logged.code);
if(user){
  let userPurchases=purchases.filter(p=>p.phone===user.phone);
  let totalPaid=0; userPurchases.forEach(p=> totalPaid+=parseFloat(p.price)||0);
  let bonus=Math.round((totalPaid*bonusPercent)/100);

  document.getElementById("userName").textContent= `ğŸ‘¤ ${user.name}`;
  document.getElementById("userCode").textContent= `ğŸ§¾ Ø§Ù„ÙƒÙˆØ¯: ${user.code}`;
  document.getElementById("userBonus").textContent= `ğŸ Ø§Ù„Ø¨ÙˆÙ†Øµ: ${bonus} Ø¬Ù†ÙŠÙ‡`;
  document.getElementById("totalPaid").textContent= `ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalPaid} Ø¬Ù†ÙŠÙ‡`;

  // ØªØ¬Ù…ÙŠØ¹ Ù†ÙØ³ Ø§Ù„Ø³Ù„Ø¹Ø© Ù…Ø¹ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§
  let grouped={};
  userPurchases.forEach((p,i)=>{
    let key=p.name;
    if(!grouped[key]) grouped[key]=[];
    grouped[key].push({...p, index:i});
  });

  let html="";
  for(let key in grouped){
    let items=grouped[key];
    let p=items[0];
    let count=items.length;
    let lastTime = new Date(p.timestamp).toLocaleString('ar-EG');
    let canCancel = (Date.now()-p.timestamp)<21600000; // Ø£Ù‚Ù„ Ù…Ù† 6 Ø³Ø§Ø¹Ø§Øª

    html+=`
    <div class="item clearfix">
      <img src="${p.image}" alt="${p.name}">
      <div class="item-details">
        <div><b>${p.name}</b></div>
        <div>âœ… ØªÙ… Ø´Ø±Ø§Ø¡: ${count} Ù…Ø±Ø©</div>
        <div>ğŸ“… Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡: ${lastTime}</div>
        <div>ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${p.price} Ø¬Ù†ÙŠÙ‡</div>
        ${canCancel ? `<button class="cancelBtn" onclick="cancelPurchase('${p.timestamp}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡</button>`:""}
      </div>
    </div>`;
  }

  document.getElementById('purchasesContainer').innerHTML=html || "ğŸ“¦ Ù„Ù… ÙŠØªÙ… Ø´Ø±Ø§Ø¡ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.";
}else{
  alert("âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
  location.href="register.html";
}

// Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡
function cancelPurchase(timestamp){
  let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
  purchases=purchases.filter(p=>p.timestamp!=timestamp);
  localStorage.setItem('purchases', JSON.stringify(purchases));
  alert("âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.");
  location.reload();
}
</script>

</body>
</html>
