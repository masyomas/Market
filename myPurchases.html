<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🛒 مشترياتي</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; text-align:center;}
header { background:#6c757d; color:#fff; padding:12px; font-size:22px;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px 0; border-top:1px solid #ddd; border-bottom:1px solid #ddd; }
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff; }
section { margin:10px auto; width:95%; max-width:600px;}
h2 { margin:10px 0; font-size:20px; }
.info-line { display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#555;}
.purchase { border:1px solid #ddd; border-radius:6px; margin:8px 0; padding:6px; display:flex; align-items:center;}
.purchase img { width:60px; height:60px; object-fit:cover; border-radius:4px; margin-left:10px;}
.purchase-details { text-align:right; flex:1;}
.purchase-details div { font-size:13px; margin:2px 0;}
button.cancelBtn { padding:4px 8px; font-size:12px; background:#dc3545; color:#fff; border:none; border-radius:4px; cursor:pointer;}
button.cancelBtn:hover { background:#a71d2a;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
</style>
</head>
<body>

<header>🛒 مشترياتي</header>

<nav>
  <a href="index.html">🛍️ المتجر</a>
  <a href="register.html">🔑 حسابي</a>
</nav>

<section>
  <h2 id="userName">اسم العميل</h2>
  <div class="info-line">
    <span id="userCode">الكود: ####</span>
    <span id="userBonus">البونص: 0 جنيه</span>
  </div>

  <div id="purchasesList"></div>
</section>

<footer>💎 Powered by Almasa 💎</footer>

<script>
// التحقق من الجلسة
let logged=JSON.parse(localStorage.getItem('loggedUser'));
if(!logged || logged.role!=="user") location.href="register.html";

let users=JSON.parse(localStorage.getItem('users')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
let bonusPercent=parseFloat(localStorage.getItem('bonusPercent')) || 1;

let user=users.find(u=>u.phone===logged.phone && u.code===logged.code);
if(!user){ alert("⚠️ مستخدم غير معرف"); location.href="register.html"; }

// عرض الاسم والكود
document.getElementById('userName').textContent=user.name;
document.getElementById('userCode').textContent="الكود: "+user.code;

// حساب البونص
let userPurchases=purchases.filter(p=>p.phone===user.phone);
let total=0;
userPurchases.forEach(p=>{ total+=parseFloat(p.price)||0; });
let bonus=Math.round((total * bonusPercent) / 100);
document.getElementById('userBonus').textContent="البونص: "+bonus+" جنيه";

// عرض المشتريات
let html="";
userPurchases.forEach(p=>{
  let timeDiff=(Date.now()-p.timestamp)/(1000*60*60); // فرق بالساعات
  let canCancel = timeDiff<6;
  html+=`
  <div class="purchase">
    <img src="${p.image||'pictures/empty.jpg'}" alt="">
    <div class="purchase-details">
      <div><b>${p.name}</b></div>
      <div>السعر: ${p.price} جنيه</div>
      <div>تاريخ الشراء: ${new Date(p.timestamp).toLocaleString('ar-EG')}</div>
    </div>
    ${canCancel? `<button class="cancelBtn" onclick="cancelPurchase(${p.timestamp})">إلغاء</button>` : ''}
  </div>`;
});
document.getElementById('purchasesList').innerHTML=html;

// إلغاء الشراء
function cancelPurchase(ts){
  if(confirm("⚠️ هل أنت متأكد من إلغاء الشراء؟")){
    purchases=purchases.filter(p=>p.timestamp!==ts);
    localStorage.setItem('purchases', JSON.stringify(purchases));
    alert("✅ تم الإلغاء");
    location.reload();
  }
}
</script>

</body>
</html>
