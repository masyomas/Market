<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🛠 لوحة الإدارة</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; text-align:center; background:#fff;}
header { background:#6c757d; color:#fff; padding:15px; font-size:22px;}
section { margin:15px auto; width:95%; max-width:850px;}
h3 { margin-top:20px; }
table { width:100%; border-collapse:collapse; margin-top:10px;}
th, td { border:1px solid #ddd; padding:6px; font-size:13px;}
.green { color:green; font-weight:bold;}
.red { color:red; font-weight:bold;}
input, select { padding:5px; margin:5px; width:60%; max-width:250px;}
button { padding:5px 10px; margin:5px; font-size:13px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer;}
button:hover { background:#555;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd;}
</style>
</head>
<body>

<header>🛠 لوحة الإدارة</header>

<section id="adminSection" style="display:none;">

  <button onclick="logoutUser()">🚪 تسجيل خروج</button>

  <h3>👥 العملاء المسجلين</h3>
  <table>
    <tr>
      <th>الاسم</th><th>الكود</th><th>عدد المشتريات</th><th>إجمالي الدفع</th><th>البونص</th><th>الحالة</th><th>خيارات</th>
    </tr>
    <tbody id="userTable"></tbody>
  </table>

  <h3>➕ إضافة سلعة جديدة</h3>
  <p>📌 أولاً ارفع الصورة يدويًا إلى مجلد picture/ في الموقع، ثم أدخل البيانات:</p>
  <input type="text" id="pname" placeholder="اسم السلعة"><br/>
  <input type="number" id="pprice" placeholder="السعر"><br/>
  <input type="text" id="pdetails" placeholder="تفاصيل السلعة"><br/>
  <input type="text" id="pimg" placeholder="اسم ملف الصورة (مثلاً picture/item.jpg)"><br/>
  <button onclick="addProduct()">✅ إضافة السلعة</button>

  <div id="superOnly" style="display:none;">
    <h3>⚙️ إعدادات السوبر أدمين</h3>
    <input type="number" id="bonus" placeholder="نسبة البونص (%)"><br/>
    <button onclick="changeBonus()">💾 حفظ النسبة</button><br/>
    <input type="email" id="adminEmail" placeholder="البريد الذي يصله إشعار الشراء"><br/>
    <button onclick="changeEmail()">💾 حفظ البريد</button>
  </div>

</section>

<footer>💎 Powered by Almasa 💎</footer>

<script>
// التحقق من الجلسة
let loggedUser = JSON.parse(localStorage.getItem('loggedUser'));
let admins = [9999,9998,9997,9996,9995]; // أكواد المدراء العاديين
let superAdminCode = 790707071;

if(!loggedUser || !(loggedUser.code === superAdminCode || admins.includes(loggedUser.code))){
  alert("❌ غير مصرح بالدخول");
  location.href = "register.html";
} else {
  document.getElementById('adminSection').style.display="block";
  if(loggedUser.code === superAdminCode){
    document.getElementById('superOnly').style.display="block";
  }
}

// تحميل العملاء
let users = JSON.parse(localStorage.getItem('users')||"[]");
let purchases = JSON.parse(localStorage.getItem('purchases')||"[]");
let bonusPerc = parseFloat(localStorage.getItem('bonusPercentage')||"0");

let html="";
users.forEach((u)=>{
  let userPurchases = purchases.filter(p=>p.userCode===u.code);
  let total = userPurchases.reduce((sum,p)=>sum+parseFloat(p.price),0);
  let bonus = total * bonusPerc/100;
  let active = (JSON.parse(localStorage.getItem('loggedUser'))?.code===u.code) ? '<span class="green">نشط</span>' : '<span class="red">غير نشط</span>';

  html+=`<tr>
  <td>${u.name}</td>
  <td>${u.code}</td>
  <td>${userPurchases.length}</td>
  <td>${total} جنيه</td>
  <td>${bonus.toFixed(2)}</td>
  <td>${active}</td>
  <td>
    <button onclick="deletePurchases(${u.code})">🗑 حذف مشتريات</button>
    ${loggedUser.code===superAdminCode?`<button onclick="deleteUser(${u.code})">❌ حذف العميل</button>`:""}
  </td>
  </tr>`;
});
document.getElementById('userTable').innerHTML=html;

// إضافة سلعة جديدة
function addProduct(){
  let name=document.getElementById('pname').value.trim();
  let price=parseFloat(document.getElementById('pprice').value.trim());
  let details=document.getElementById('pdetails').value.trim();
  let img=document.getElementById('pimg').value.trim();

  if(!name || !price || !img){
    alert("⚠️ أدخل الاسم والسعر واسم ملف الصورة");
    return;
  }
  let products=JSON.parse(localStorage.getItem('products')||"[]");
  products.push({name,price,details,img});
  localStorage.setItem('products',JSON.stringify(products));
  alert("✅ تمت إضافة السلعة");
}

// تغيير نسبة البونص
function changeBonus(){
  let perc=parseFloat(document.getElementById('bonus').value.trim());
  if(isNaN(perc)||perc<0){ alert("⚠️ أدخل نسبة صحيحة"); return;}
  localStorage.setItem('bonusPercentage',perc);
  alert("✅ تم حفظ النسبة");
}

// تغيير البريد
function changeEmail(){
  let email=document.getElementById('adminEmail').value.trim();
  if(!email.includes('@')){ alert("⚠️ أدخل بريد صحيح"); return;}
  localStorage.setItem('adminEmail',email);
  alert("✅ تم حفظ البريد");
}

// حذف مشتريات عميل
function deletePurchases(code){
  let all=JSON.parse(localStorage.getItem('purchases')||"[]");
  all=all.filter(p=>p.userCode!==code);
  localStorage.setItem('purchases',JSON.stringify(all));
  alert("✅ تم حذف المشتريات");
  location.reload();
}

// حذف عميل
function deleteUser(code){
  if(!confirm("❌ تأكيد حذف العميل؟")) return;
  let users=JSON.parse(localStorage.getItem('users')||"[]");
  users=users.filter(u=>u.code!==code);
  localStorage.setItem('users',JSON.stringify(users));
  deletePurchases(code);
  alert("✅ تم حذف العميل");
  location.reload();
}

// تسجيل خروج
function logoutUser(){
  localStorage.removeItem('loggedUser');
  alert("👋 تم تسجيل الخروج");
  location.href="register.html";
}

// التقاط تسجيل خروج في تبويبة أخرى
window.addEventListener('storage',function(e){
  if(e.key==='loggedUser' && e.newValue===null){
    alert("👋 تم تسجيل خروجك في تبويبة أخرى");
    location.href='register.html';
  }
});
</script>

</body>
</html>
