<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🛠️ لوحة الإدارة</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff;}
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px; border-top:1px solid #ddd; border-bottom:1px solid #ddd;}
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff;}
section { margin:10px auto; width:95%; max-width:700px;}
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px;}
input[type=text], input[type=number], input[type=file] { width:95%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;}
button { background:#28a745; color:#fff; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; margin:4px 0;}
button:hover { background:#218838;}
.logoutBtn { background:#dc3545; }
.logoutBtn:hover { background:#c82333;}
table { width:100%; border-collapse:collapse; margin-top:8px;}
td, th { border:1px solid #ccc; padding:4px; font-size:13px; text-align:center;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
</style>
</head>
<body>

<header>🛠️ لوحة الإدارة</header>

<nav>
  <a href="index.html">🏪 المتجر</a>
  <a href="admin.html">📊 مبيعاتي</a>
  <a href="register.html">🔑 حسابي</a>
</nav>

<section id="adminSection">
  <h3>مرحبًا سوبر أدمن</h3>
  <button class="logoutBtn" onclick="logout()">تسجيل خروج</button>

  <h3>إضافة سلعة جديدة</h3>
  <input type="text" id="pName" placeholder="اسم السلعة">
  <input type="number" id="pPrice" placeholder="سعر السلعة">
  <input type="text" id="pDetails" placeholder="تفاصيل السلعة">
  <input type="file" id="pImg">
  <button onclick="addProduct()">إضافة</button>

  <h3>السلع المضافة</h3>
  <div id="productsList"></div>

  <h3>📄 مبيعاتي</h3>
  <div id="salesTable"></div>

  <h3>🧾 إصدار فاتورة</h3>
  <select id="invoiceClient">
    <option value="">اختر عميلًا</option>
  </select>
  <button onclick="generateInvoice()">إظهار الفاتورة</button>
  <div id="invoiceContent"></div>
</section>

<footer>💎 Powered by Almasa 💎</footer>

<script>
let logged=JSON.parse(localStorage.getItem('loggedUser'));
let users=JSON.parse(localStorage.getItem('users')||"[]");
let products=JSON.parse(localStorage.getItem('products')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");

// تحقق من الدخول
if(!logged || logged.role!=="superadmin"){
  alert("⚠️ غير مصرح لك بالدخول هنا.");
  location.href='register.html';
}

// عرض المنتجات
function showProducts(){
  let html="";
  if(products.length){
    html+=`<table>
    <tr><th>صورة</th><th>الاسم</th><th>السعر</th><th>تفاصيل</th><th>حذف</th></tr>`;
    products.forEach((p,i)=>{
      html+=`<tr>
      <td><img src="${p.img||'https://via.placeholder.com/50'}" width="50"></td>
      <td>${p.name}</td>
      <td>${p.price}</td>
      <td>${p.details}</td>
      <td><button onclick="delProduct(${i})">🗑️</button></td></tr>`;
    });
    html+=`</table>`;
  }else{
    html="<p>🚫 لا توجد سلع بعد.</p>";
  }
  document.getElementById('productsList').innerHTML=html;
}

// إضافة منتج
function addProduct(){
  let name=document.getElementById('pName').value.trim();
  let price=parseFloat(document.getElementById('pPrice').value);
  let details=document.getElementById('pDetails').value.trim();
  let imgInput=document.getElementById('pImg');
  if(!name||!price||!details){ alert("❗ أكمل كل البيانات"); return; }

  if(imgInput.files.length){
    let reader=new FileReader();
    reader.onload=function(e){
      products.push({name,price,details,img:e.target.result});
      localStorage.setItem('products', JSON.stringify(products));
      showProducts();
    };
    reader.readAsDataURL(imgInput.files[0]);
  }else{
    products.push({name,price,details,img:""});
    localStorage.setItem('products', JSON.stringify(products));
    showProducts();
  }
}

// حذف منتج
function delProduct(i){
  if(confirm("⚠️ حذف السلعة؟")){
    products.splice(i,1);
    localStorage.setItem('products', JSON.stringify(products));
    showProducts();
  }
}

// عرض المبيعات
function showSales(){
  if(!purchases.length){
    document.getElementById('salesTable').innerHTML="<p>📦 لا توجد مبيعات بعد.</p>";
    return;
  }
  let html=`<table>
  <tr><th>العميل</th><th>الهاتف</th><th>الكود</th><th>السلعة</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th>تاريخ الشراء</th></tr>`;
  purchases.forEach(p=>{
    let u=users.find(u=>u.code==p.code) || {};
    let subtotal=p.qty*p.price;
    html+=`<tr>
      <td>${u.name||"?"}</td>
      <td>${u.phone||"?"}</td>
      <td>${p.code}</td>
      <td>${p.product}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${subtotal}</td>
      <td>${p.date}</td>
    </tr>`;
  });
  html+=`</table>`;
  document.getElementById('salesTable').innerHTML=html;
}

// تجهيز العملاء للفاتورة
function prepareInvoiceClients(){
  let sel=document.getElementById('invoiceClient');
  sel.innerHTML='<option value="">اختر عميلًا</option>'+
    users.filter(u=>u.role==="user")
    .map(u=>`<option value="${u.code}">${u.name} - ${u.phone}</option>`).join('');
}

// توليد الفاتورة
function generateInvoice(){
  let code=document.getElementById('invoiceClient').value;
  let u=users.find(u=>u.code==code);
  if(!u){
    document.getElementById('invoiceContent').innerHTML="<p>⚠️ لم يتم العثور على بيانات العميل.</p>";
    return;
  }
  let userPurchases=purchases.filter(p=>p.code==code);
  if(!userPurchases.length){
    document.getElementById('invoiceContent').innerHTML="<p>📦 لا توجد مشتريات لهذا العميل.</p>";
    return;
  }

  let html=`<div>👤 الاسم: ${u.name} | 📞 الهاتف: ${u.phone} | 🧾 الكود: ${u.code}</div>
  <table>
  <tr><th>السلعة</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr>`;
  let total=0;
  userPurchases.forEach(p=>{
    let subtotal=p.qty*p.price;
    total+=subtotal;
    html+=`<tr>
      <td>${p.product}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${subtotal}</td>
    </tr>`;
  });
  html+=`<tr><td colspan="3">💰 الإجمالي</td><td>${total}</td></tr></table>
  <div>📅 التاريخ: ${new Date().toLocaleString('ar-EG')}</div>
  <button onclick="window.print()">🖨️ طباعة الفاتورة</button>`;
  document.getElementById('invoiceContent').innerHTML=html;
}

// تسجيل خروج
function logout(){
  localStorage.removeItem('loggedUser');
  location.href='register.html';
}

// تشغيل
showProducts();
showSales();
prepareInvoiceClients();
</script>

</body>
</html>
