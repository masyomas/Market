<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff;}
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px; border-top:1px solid #ddd; border-bottom:1px solid #ddd;}
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff;}
section { margin:10px auto; width:95%; max-width:800px;}
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px;}
table { width:100%; border-collapse:collapse; margin-top:8px;}
td, th { border:1px solid #ccc; padding:4px; font-size:13px;}
button { background:#28a745; color:#fff; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; margin:4px 0;}
button:hover { background:#218838;}
.delBtn { background:#dc3545; }
.delBtn:hover { background:#c82333;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
input[type=text], input[type=password] { width:95%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;}
label { display:block; font-size:13px; margin-top:4px;}
/* Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· */
@media print {
  body * { visibility:hidden; }
  #invoicePrintArea, #invoicePrintArea * { visibility:visible; }
  #invoicePrintArea { position:absolute; top:0; right:0; left:0; }
}
</style>
</head>
<body>

<header>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</header>

<nav>
  <a href="index.html">ğŸ  Ø§Ù„Ù…ØªØ¬Ø±</a>
  <a href="myPurchases.html">ğŸ›’ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</a>
  <a href="register.html">ğŸ”‘ Ø­Ø³Ø§Ø¨ÙŠ</a>
</nav>

<section id="adminContent">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
let logged = JSON.parse(localStorage.getItem('loggedUser'));
let users = JSON.parse(localStorage.getItem('users') || "[]");
let purchases = JSON.parse(localStorage.getItem('purchases') || "[]");

function renderAdmin(){
  if(!logged || logged.role !== "superadmin"){
    document.getElementById('adminContent').innerHTML = '<p>ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§.</p>';
    return;
  }

  let html = `<h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ${logged.name} (Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†)</h3>
  <div>ğŸ“ Ù‡Ø§ØªÙÙƒ: ${logged.phone} | ğŸ†” ÙƒÙˆØ¯Ùƒ: ${logged.code}</div>
  <button onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`;

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±
  html += `<h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
    <input type="text" id="adminName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±">
    <input type="text" id="adminPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <label><input type="checkbox" id="permViewUsers"> Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
    <label><input type="checkbox" id="permAddUsers"> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
    <label><input type="checkbox" id="permDeleteUsers"> Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
    <label><input type="checkbox" id="permViewSales"> Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
    <label><input type="checkbox" id="permDeleteSales"> Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</label>
    <button onclick="addAdmin()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±</button>`;

  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  html += `<h3>ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <table>
    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø¯ÙˆØ±</th></tr>`;
  users.forEach(u=>{
    html += `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.code}</td><td>${u.role}</td></tr>`;
  });
  html += `</table>`;

  html += `<button class="delBtn" onclick="clearUsers()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø¯Ø§ Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†</button>`;

  // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  html += `<h3>ğŸ’° Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>`;
  if(purchases.length){
    html += `<table>
    <tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>`;
    purchases.forEach(p=>{
      html += `<tr>
        <td>${p.product}</td>
        <td>${p.code}</td>
        <td>${p.phone}</td>
        <td>${p.qty}</td>
        <td>${p.price}</td>
        <td>${p.qty*p.price}</td>
        <td>${p.timestamp||"â€”"}</td>
      </tr>`;
    });
    html += `</table>`;
  }else{
    html += `<p>ğŸ“¦ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</p>`;
  }

  html += `<button class="delBtn" onclick="clearPurchases()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø³Ø±)</button>`;

  // Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø©
  html += `<h3>ğŸ§¾ Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© Ù„Ø¹Ù…ÙŠÙ„</h3>
    <select id="invoiceSelect">
      <option value="">Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>`;
  users.filter(u=>u.role=="user").forEach(u=>{
    html += `<option value="${u.code}">${u.name} - ÙƒÙˆØ¯:${u.code}</option>`;
  });
  html += `</select>
    <button onclick="showInvoice()">Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <div id="invoicePrintArea"></div>`;

  document.getElementById('adminContent').innerHTML = html;
}

function addAdmin(){
  let name = document.getElementById('adminName').value.trim();
  let phone = document.getElementById('adminPhone').value.trim();
  let pass = document.getElementById('adminPass').value.trim();
  let code = Math.floor(2001 + Math.random()*7999);
  let permissions = {
    canViewUsers: document.getElementById('permViewUsers').checked,
    canAddUsers: document.getElementById('permAddUsers').checked,
    canDeleteUsers: document.getElementById('permDeleteUsers').checked,
    canViewSales: document.getElementById('permViewSales').checked,
    canDeleteSales: document.getElementById('permDeleteSales').checked
  };
  if(!name || !phone || !pass){ alert("â— Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); return; }
  if(users.find(u=>u.phone===phone)){ alert("âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."); return; }

  users.push({ name, phone, password:pass, code, role:"admin", permissions });
  localStorage.setItem('users', JSON.stringify(users));
  alert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨ÙƒÙˆØ¯: ${code}`);
  renderAdmin();
}

function clearUsers(){
  if(confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")){
    let superAdmin = users.find(u=>u.role=="superadmin");
    localStorage.setItem('users', JSON.stringify([superAdmin]));
    alert("âœ… ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.");
    location.reload();
  }
}

function clearPurchases(){
  let pass = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:");
  if(pass==="790707071"){
    localStorage.removeItem('purchases');
    alert("âœ… ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.");
    location.reload();
  }else{
    alert("âŒ ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø©.");
  }
}

function showInvoice(){
  let code=document.getElementById('invoiceSelect').value;
  if(!code) return;
  let u=users.find(u=>u.code==code);
  if(!u) return;

  let userPurchases=purchases.filter(p=>p.code==code);
  let grouped=[];
  userPurchases.forEach(p=>{
    let exist=grouped.find(g=>g.product==p.product && g.price==p.price);
    if(exist){ exist.qty+=p.qty; }
    else{ grouped.push({product:p.product, qty:p.qty, price:p.price}); }
  });

  let bonus = grouped.reduce((sum,item)=>sum+item.qty,0); // Ù…Ø«Ø§Ù„ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙˆÙ†Øµ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹
  let total=0;

  let html=`<div style="margin-top:10px; text-align:right;">
  <h3>ğŸ›ï¸ Almasa Store</h3>
  <div>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${u.name}</div>
  <div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${u.phone}</div>
  <div>ğŸ§¾ Ø§Ù„ÙƒÙˆØ¯: ${u.code}</div>
  <div>ğŸ… Ø§Ù„Ø¨ÙˆÙ†Øµ: ${bonus}</div>
  <div>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-EG')}</div>
  <table>
  <tr><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>`;
  grouped.forEach(item=>{
    let subtotal=item.qty*item.price;
    total+=subtotal;
    html+=`<tr><td>${item.product}</td><td>${item.qty}</td><td>${item.price}</td><td>${subtotal}</td></tr>`;
  });
  html+=`<tr><td colspan="3">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td>${total}</td></tr></table>
  <footer style="margin-top:10px;">ğŸ’ Powered by Almasa ğŸ’</footer>
  <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
  </div>`;
  document.getElementById('invoicePrintArea').innerHTML=html;
}

function logout(){
  localStorage.removeItem('loggedUser');
  location.href='register.html';
}

renderAdmin();
</script>

</body>
</html>
