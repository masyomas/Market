<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff;}
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px; border-top:1px solid #ddd; border-bottom:1px solid #ddd;}
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff;}
section { margin:10px auto; width:95%; max-width:800px;}
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px;}
input[type=text], input[type=number], input[type=file], select { width:95%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;}
button { background:#28a745; color:#fff; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; margin:4px 0;}
button:hover { background:#218838;}
.logoutBtn { background:#dc3545; }
.logoutBtn:hover { background:#c82333;}
table { width:100%; border-collapse:collapse; margin-top:8px;}
td, th { border:1px solid #ccc; padding:4px; font-size:13px; text-align:center;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
.green {color:green;}
.red {color:red;}
.tab { display:none; }
.active { display:block; }
</style>
</head>
<body>

<header>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</header>

<nav>
  <a href="#" onclick="showTab('productsTab')">ğŸ“¦ Ø§Ù„Ø³Ù„Ø¹</a>
  <a href="#" onclick="showTab('salesTab')">ğŸ“Š Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
  <a href="#" onclick="showTab('adminsTab')">ğŸ‘¥ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</a>
  <a href="#" onclick="showTab('invoiceTab')">ğŸ“„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</a>
  <a href="#" onclick="logout()" class="logoutBtn">ğŸšª Ø®Ø±ÙˆØ¬</a>
</nav>

<section id="productsTab" class="tab active"></section>
<section id="salesTab" class="tab"></section>
<section id="adminsTab" class="tab"></section>
<section id="invoiceTab" class="tab"></section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
let logged=JSON.parse(localStorage.getItem('loggedUser'));
let users=JSON.parse(localStorage.getItem('users')||"[]");
let products=JSON.parse(localStorage.getItem('products')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
let bonus=parseFloat(localStorage.getItem('bonus')||"1");

if(!logged || (logged.role!=="superadmin" && logged.role!=="admin")){
  document.body.innerHTML='<p style="text-align:center;margin:20px;">ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§.</p>';
}else{
  renderAllTabs();
}

function showTab(tabId){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

function logout(){
  localStorage.removeItem('loggedUser');
  location.href='register.html';
}

// ======== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ù„Ø¹ ========
function renderProducts(){
let html=`
<h3>Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
<input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©">
<input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø³Ù„Ø¹Ø©">
<input type="text" id="pDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹Ø©">
<input type="file" id="pImg">
<button onclick="addProduct()">Ø¥Ø¶Ø§ÙØ©</button>
<h3>Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>`;
if(products.length){
  html+=`<table><tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr>`;
  products.forEach((p,i)=>{
    html+=`<tr>
    <td><img src="${p.img||'https://via.placeholder.com/50'}" width="50"></td>
    <td>${p.name}</td>
    <td><input type="number" value="${p.price}" onchange="updateProductPrice(${i},this.value)"></td>
    <td>${p.details}</td>
    <td><button onclick="delProduct(${i})">ğŸ—‘ï¸</button></td></tr>`;
  });
  html+=`</table>`;
}else{ html+=`<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ø¹ Ø¨Ø¹Ø¯.</p>`; }
document.getElementById('productsTab').innerHTML=html;
}

function addProduct(){
  let name=document.getElementById('pName').value.trim();
  let price=parseFloat(document.getElementById('pPrice').value);
  let details=document.getElementById('pDetails').value.trim();
  let imgInput=document.getElementById('pImg');
  if(!name||!price||!details){ alert("â— Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return;}
  let img="";
  if(imgInput.files.length){
    let reader=new FileReader();
    reader.onload=e=>{
      img=e.target.result;
      products.push({name,price,details,img});
      localStorage.setItem('products', JSON.stringify(products));
      renderProducts();
    };
    reader.readAsDataURL(imgInput.files[0]);
  }else{
    products.push({name,price,details,img});
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
  }
}

function delProduct(i){
  if(confirm("âš ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ù„Ø¹Ø©ØŸ")){
    products.splice(i,1);
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
  }
}

function updateProductPrice(i,newPrice){
  products[i].price=parseFloat(newPrice);
  localStorage.setItem('products', JSON.stringify(products));
}

// ======== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ========
function renderSales(){
let html=`<h3>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>`;
if(purchases.length){
  html+=`<table><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr>`;
  purchases.forEach(p=>{
    let u=users.find(u=>u.code===p.code);
    html+=`<tr><td>${p.name}</td><td>${u?.phone||''}</td><td>${p.code}</td><td>${p.product}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.date}</td></tr>`;
  });
  html+=`</table>
  <button onclick="clearPurchases()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>`;
}else{ html+=`<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</p>`; }
document.getElementById('salesTab').innerHTML=html;
}

function clearPurchases(){
  let pass=prompt("ğŸ’¡ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù† Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
  let superAdmin=users.find(u=>u.role==="superadmin");
  if(pass===superAdmin?.code.toString()){
    purchases=[];
    localStorage.setItem('purchases',JSON.stringify(purchases));
    alert("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.");
    renderSales();
  }else{
    alert("âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.");
  }
}

// ======== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ ========
function renderAdmins(){
let admins=users.filter(u=>u.role==="admin");
let html=`<h3>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h3>`;
if(logged.role==="superadmin"){
  html+=`<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙˆØ¯</th></tr>`;
  admins.forEach((a,i)=>{
    html+=`<tr>
    <td>${a.name}</td>
    <td><input value="${a.phone}" onchange="editAdmin(${i},'phone',this.value)"></td>
    <td><input value="${a.code}" onchange="editAdmin(${i},'code',this.value)"></td>
    </tr>`;
  });
  html+=`</table>`;
}else{
  html+=`<p>â— ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.</p>`;
}
document.getElementById('adminsTab').innerHTML=html;
}

function editAdmin(i,field,value){
  let admins=users.filter(u=>u.role==="admin");
  admins[i][field]=value;
  users=users.map(u=>u.role==="admin"?admins.shift():u);
  localStorage.setItem('users',JSON.stringify(users));
}

// ======== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ========
function renderInvoice(){
let html=`<h3>ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø©</h3>
<select id="clientSelect" onchange="showInvoice(this.value)">
<option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„...</option>`;
users.filter(u=>u.role==="user").forEach(u=>{
  html+=`<option value="${u.code}">${u.name} - ${u.phone}</option>`;
});
html+=`</select>
<div id="invoiceDetails"></div>`;
document.getElementById('invoiceTab').innerHTML=html;
}

function showInvoice(code){
let u=users.find(u=>u.code==code);
if(!u) return;
let userPurchases=purchases.filter(p=>p.code==code);
let grouped={};
userPurchases.forEach(p=>{
  if(!grouped[p.product]) grouped[p.product]={qty:0, price:p.price};
  grouped[p.product].qty+=p.qty;
});
let html=`
<div style="margin-top:10px;">
<div>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${u.name}</div>
<div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${u.phone}</div>
<div>ğŸ§¾ Ø§Ù„ÙƒÙˆØ¯: ${u.code}</div>
<div>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-EG')}</div>
<table>
<tr><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>`;
let total=0;
for(let prod in grouped){
  let item=grouped[prod];
  let subtotal=item.qty*item.price;
  total+=subtotal;
  html+=`<tr><td>${prod}</td><td>${item.qty}</td><td>${item.price}</td><td>${subtotal}</td></tr>`;
}
html+=`<tr><td colspan="3">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td>${total}</td></tr></table>
<button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>`;
document.getElementById('invoiceDetails').innerHTML=html;
}

// ======== render all ========
function renderAllTabs(){
  renderProducts();
  renderSales();
  renderAdmins();
  renderInvoice();
}
</script>

</body>
</html>
