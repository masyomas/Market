<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>💎 لوحة الإدارة الشاملة</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; }
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center; position:sticky; top:0; }
nav { display:flex; justify-content:space-around; background:#f8f9fa; border-bottom:1px solid #ddd; }
nav button { flex:1; padding:8px; border:none; background:none; cursor:pointer; font-size:14px; }
nav button.active { background:#007bff; color:#fff; }
section { margin:10px auto; width:95%; max-width:800px; }
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px; margin-top:10px; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
td, th { border:1px solid #ccc; padding:4px; font-size:13px; text-align:center; }
button.action { background:#28a745; color:#fff; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; margin:2px; }
button.action:hover { background:#218838; }
.delBtn { background:#dc3545; }
.delBtn:hover { background:#c82333; }
input[type=number], input[type=text], input[type=password] { width:90%; padding:4px; margin:4px 0; border:1px solid #ccc; border-radius:4px; }
label { font-size:13px; }
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; margin-top:10px; }
</style>
</head>
<body>

<header>💎 لوحة الإدارة الشاملة</header>

<nav id="tabs">
  <button onclick="showTab('dashboard')" class="active">🏠 لوحة التحكم</button>
  <button onclick="showTab('sales')">💰 المبيعات</button>
</nav>

<section id="content">⏳ جاري التحميل...</section>

<footer>💎 Powered by Almasa 💎</footer>

<script>
let logged = JSON.parse(localStorage.getItem('loggedUser'));
let users = JSON.parse(localStorage.getItem('users')||"[]");
let products = JSON.parse(localStorage.getItem('products')||"[]");
let purchases = JSON.parse(localStorage.getItem('purchases')||"[]");
let bonus = parseFloat(localStorage.getItem('bonus')||"1");

if(!logged || logged.role!=="superadmin"){ document.getElementById('content').innerHTML='🚫 لا تملك صلاحية الدخول.'; }
else { showTab('dashboard'); }

function showTab(tab){
  document.querySelectorAll('#tabs button').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`#tabs button[onclick*="${tab}"]`).classList.add('active');
  if(tab==='dashboard') renderDashboard();
  else if(tab==='sales') renderSales();
}

function renderDashboard(){
  let html=`<h3>🏠 لوحة التحكم</h3>
  <div>مرحبًا ${logged.name} | هاتف: ${logged.phone} | كودك: ${logged.code}</div>
  <h3>📊 تحديد نسبة البونص</h3>
  <input type="number" id="bonusInput" value="${bonus}" placeholder="مثال: 1.5">
  <button onclick="updateBonus()" class="action">💾 حفظ البونص</button>
  <h3>👥 إدارة المديرين</h3>
  <input type="text" id="adminName" placeholder="اسم المدير">
  <input type="text" id="adminPhone" placeholder="رقم الهاتف">
  <input type="password" id="adminPass" placeholder="كلمة المرور">
  <label><input type="checkbox" id="permViewSales"> مشاهدة المبيعات</label>
  <label><input type="checkbox" id="permDeleteSales"> حذف المبيعات</label>
  <button onclick="addAdmin()" class="action">➕ إضافة مدير</button>
  <table><tr><th>الاسم</th><th>الهاتف</th><th>الدور</th></tr>`;
  users.filter(u=>u.role==="admin").forEach(u=>{
    html+=`<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.role}</td></tr>`;
  });
  html+=`</table>`;
  document.getElementById('content').innerHTML=html;
}

function renderSales(){
  let html=`<h3>💰 المبيعات</h3>`;
  if(purchases.length){
    html+=`<table>
    <tr><th>المنتج</th><th>الكمية المباعة</th><th>سعر الوحدة</th><th>الإجمالي</th><th>المتبقي (من 100)</th><th>حذف</th></tr>`;
    purchases.forEach((p,i)=>{
      let remaining=100-p.qty;
      html+=`<tr>
      <td>${p.product}</td>
      <td>${p.qty}</td>
      <td>${p.price}</td>
      <td>${p.qty*p.price}</td>
      <td>${remaining}</td>
      <td><input type="checkbox" onchange="delPurchase(${i}, this.checked)"></td>
      </tr>`;
    });
    html+=`</table>`;
  }else{ html+="<p>📦 لا توجد مبيعات بعد.</p>"; }
  document.getElementById('content').innerHTML=html;
}

function updateBonus(){
  let newBonus=parseFloat(document.getElementById('bonusInput').value);
  if(isNaN(newBonus) || newBonus<=0){ alert("❗ أدخل رقم صحيح."); return;}
  bonus=newBonus;
  localStorage.setItem('bonus', bonus);
  alert("✅ تم تحديث نسبة البونص.");
}

function addAdmin(){
  let name=document.getElementById('adminName').value.trim();
  let phone=document.getElementById('adminPhone').value.trim();
  let pass=document.getElementById('adminPass').value.trim();
  let code=Math.floor(2000+Math.random()*8000);
  let permissions={
    canViewSales:document.getElementById('permViewSales').checked,
    canDeleteSales:document.getElementById('permDeleteSales').checked
  };
  if(!name||!phone||!pass){ alert("❗ أكمل البيانات."); return;}
  users.push({name,phone,password:pass,code,role:"admin",permissions});
  localStorage.setItem('users', JSON.stringify(users));
  alert(`✅ أضيف المدير بكود: ${code}`);
  renderDashboard();
}

function delPurchase(i,checked){
  if(checked){
    if(confirm("⚠️ تأكيد حذف الصف؟")){
      purchases.splice(i,1);
      localStorage.setItem('purchases', JSON.stringify(purchases));
      renderSales();
    }
  }
}
</script>

</body>
</html>
