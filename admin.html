<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff;}
header { background:#6c757d; color:#fff; padding:12px; font-size:20px; text-align:center;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px; border-top:1px solid #ddd; border-bottom:1px solid #ddd;}
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff;}
section { margin:10px auto; width:95%; max-width:900px;}
h3 { background:#007bff; color:#fff; padding:6px; border-radius:4px; font-size:17px;}
input[type=text], input[type=number], select { width:95%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;}
button { background:#28a745; color:#fff; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; margin:4px 0;}
button:hover { background:#218838;}
.logoutBtn { background:#dc3545; }
.logoutBtn:hover { background:#c82333;}
table { width:100%; border-collapse:collapse; margin-top:8px;}
td, th { border:1px solid #ccc; padding:4px; font-size:13px; text-align:center;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
tr:nth-child(even){background:#f9f9f9;}
</style>
</head>
<body>

<header>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</header>

<nav>
  <a href="#admins">ğŸ‘¥ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</a>
  <a href="#products">ğŸ›ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø¹</a>
  <a href="#sales">ğŸ“Š Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
  <a href="#invoice">ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</a>
  <button class="logoutBtn" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</nav>

<section id="adminSection">
  <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
</section>

<footer>ğŸ’ Powered by Almasa ğŸ’</footer>

<script>
let logged=JSON.parse(localStorage.getItem('loggedUser'));
let users=JSON.parse(localStorage.getItem('users')||"[]");
let products=JSON.parse(localStorage.getItem('products')||"[]");
let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
let bonus=parseFloat(localStorage.getItem('bonus')||"1");

function renderAdmin(){
  if(!logged || (logged.role!=="superadmin" && logged.role!=="admin")){
    document.getElementById('adminSection').innerHTML='<p>ğŸš« Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§.</p>';
    return;
  }
  let html=`<h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ${logged.name}</h3>`;

  // Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡
  if(logged.role==="superadmin"){
    html+=`<h3 id="admins">ğŸ‘¥ Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</h3>
    <table>
    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>ØªØ­Ø¯ÙŠØ«</th></tr>`;
    users.filter(u=>u.role==="admin").forEach((u,i)=>{
      html+=`<tr>
        <td><input value="${u.name}" onchange="editAdmin('${u.code}','name',this.value)"></td>
        <td><input value="${u.phone}" onchange="editAdmin('${u.code}','phone',this.value)"></td>
        <td><input value="${u.code}" onchange="editAdmin('${u.code}','code',this.value)"></td>
        <td><button onclick="deleteAdmin('${u.code}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
      </tr>`;
    });
    html+=`</table>
    <input type="number" id="bonusInput" placeholder="ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨ÙˆÙ†Øµ (Ø­Ø§Ù„ÙŠÙ‹Ø§ ${bonus}%)">
    <button onclick="updateBonus()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨Ø©</button>`;
  }

  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø¹
  html+=`<h3 id="products">ğŸ›ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø¹</h3>
  <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©">
  <input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
  <input id="pDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ù‚ØµÙŠØ±Ø©">
  <input id="pImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
  <button onclick="addProduct()">â• Ø¥Ø¶Ø§ÙØ©</button>`;

  if(products.length){
    html+=`<table>
    <tr><th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø­Ø°Ù</th></tr>`;
    products.forEach((p,i)=>{
      html+=`<tr>
        <td><img src="${p.img||'https://via.placeholder.com/50'}" width="50"></td>
        <td>${p.name}</td>
        <td>${p.price}</td>
        <td>${p.details}</td>
        <td><button onclick="deleteProduct(${i})">ğŸ—‘ï¸</button></td>
      </tr>`;
    });
    html+=`</table>`;
  }

  // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  html+=`<h3 id="sales">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>`;
  if(purchases.length){
    html+=`<table>
    <tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>ØªØ§Ø±ÙŠØ®</th></tr>`;
    purchases.forEach(p=>{
      let subtotal=p.qty*p.price;
      html+=`<tr style="background-color:${colorByCode(p.code)};">
        <td>${p.name||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
        <td>${findPhoneByCode(p.code)||'?'}</td>
        <td>${p.code}</td>
        <td>${p.product}</td>
        <td>${p.qty}</td>
        <td>${p.price}</td>
        <td>${subtotal}</td>
        <td>${p.date}</td>
      </tr>`;
    });
    html+=`</table>
    <button onclick="clearPurchases()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„ (ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†)</button>`;
  }else{
    html+=`<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</p>`;
  }

  // Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  html+=`<h3 id="invoice">ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
  <select id="invoiceSelect"><option disabled selected>Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>${
    users.map(u=>`<option value="${u.code}">${u.name} (${u.code})</option>`).join('')
  }</select>
  <button onclick="showInvoice()">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
  <div id="invoiceDetails"></div>`;

  document.getElementById('adminSection').innerHTML=html;
}

// Ø£Ù„ÙˆØ§Ù† ÙØ±ÙŠØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯
function colorByCode(code){
  let hash=0;
  for(let i=0;i<code.length;i++) hash=code.charCodeAt(i)+((hash<<5)-hash);
  let color = `hsl(${hash%360},70%,90%)`;
  return color;
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
function findPhoneByCode(code){
  let u=users.find(u=>u.code==code);
  return u?u.phone:null;
}

// Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø¹Ø©
function addProduct(){
  let name=document.getElementById('pName').value.trim();
  let price=parseFloat(document.getElementById('pPrice').value);
  let details=document.getElementById('pDetails').value.trim();
  let img=document.getElementById('pImg').value.trim();
  if(!name||!price||!details){ alert('â— Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  products.push({name,price,details,img});
  localStorage.setItem('products', JSON.stringify(products));
  renderAdmin();
}

// Ø­Ø°Ù Ø³Ù„Ø¹Ø©
function deleteProduct(i){
  if(confirm('âš ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ù„Ø¹Ø©ØŸ')){ products.splice(i,1);
    localStorage.setItem('products', JSON.stringify(products));
    renderAdmin(); }
}

// ØªØ­Ø±ÙŠØ± Ù…Ø¯ÙŠØ±
function editAdmin(oldCode,field,value){
  let u=users.find(u=>u.code==oldCode);
  if(u){ u[field]=value; localStorage.setItem('users',JSON.stringify(users)); }
}

// Ø­Ø°Ù Ù…Ø¯ÙŠØ±
function deleteAdmin(code){
  if(confirm('âš ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±ØŸ')){
    users=users.filter(u=>u.code!=code);
    localStorage.setItem('users', JSON.stringify(users));
    renderAdmin();
  }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆÙ†Øµ
function updateBonus(){
  let b=parseFloat(document.getElementById('bonusInput').value);
  if(isNaN(b)||b<0){ alert('â— Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© ØµØ­ÙŠØ­Ø©'); return;}
  localStorage.setItem('bonus',b); bonus=b;
  renderAdmin();
}

// Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function clearPurchases(){
  let pwd=prompt('ğŸ”’ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†');
  if(pwd==='790707071'){ purchases=[]; localStorage.setItem('purchases','[]'); renderAdmin();}
  else alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
}

// Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function showInvoice(){
  let code=document.getElementById('invoiceSelect').value;
  let u=users.find(u=>u.code==code);
  if(!u) return;
  let userPurchases=purchases.filter(p=>p.code==code);

  // ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
  let grouped={};
  userPurchases.forEach(p=>{
    if(!grouped[p.product]){
      grouped[p.product]={ qty:0, price:p.price, dates:[p.date] };
    }else{
      grouped[p.product].dates.push(p.date);
    }
    grouped[p.product].qty+=p.qty;
  });

  let html=`<div style="margin-top:10px;">
  <div>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${u.name}</div>
  <div>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${u.phone}</div>
  <div>ğŸ§¾ Ø§Ù„ÙƒÙˆØ¯: ${u.code}</div>
  <table>
  <tr><th>Ø§Ù„Ø³Ù„Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ø´Ø±Ø§Ø¡</th></tr>`;
  let total=0;

  for(let prod in grouped){
    let item=grouped[prod];
    let subtotal=item.qty * item.price;
    total+=subtotal;
    let lastDate=item.dates[item.dates.length-1];
    html+=`<tr>
      <td>${prod}</td>
      <td>${item.qty}</td>
      <td>${item.price}</td>
      <td>${subtotal}</td>
      <td>${lastDate}</td>
    </tr>`;
  }

  html+=`<tr><td colspan="4">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td><td>${total}</td></tr></table>
  <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>`;

  document.getElementById('invoiceDetails').innerHTML=html;
}

// Ø®Ø±ÙˆØ¬
function logout(){ localStorage.removeItem('loggedUser'); location.href='register.html'; }

renderAdmin();
</script>

</body>
</html>
