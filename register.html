<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔑 التسجيل / تسجيل الدخول</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; background:#fff; text-align:center;}
header { background:#6c757d; color:#fff; padding:12px; font-size:22px;}
nav { background:#f8f9fa; display:flex; justify-content:space-around; padding:8px 0; border-top:1px solid #ddd; border-bottom:1px solid #ddd;}
nav a { text-decoration:none; color:#333; font-size:14px;}
nav a:hover { color:#007bff; }
section { margin:10px auto; width:90%; max-width:400px;}
input[type=text], input[type=number] { width:90%; padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:4px;}
button { background:#007bff; color:#fff; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; margin:5px 0;}
button:hover { background:#0056b3;}
.logoutBtn { background:#dc3545; }
.logoutBtn:hover { background:#c82333;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd; margin-top:10px;}
</style>
</head>
<body>

<header>🔑 التسجيل / تسجيل الدخول</header>

<nav>
  <a href="index.html">🏠 المتجر</a>
  <a href="myPurchases.html">🛒 مشترياتي</a>
  <a href="register.html">🔑 حسابي</a>
</nav>

<section>
  <div id="formsContainer"></div>
</section>

<footer>💎 Powered by Almasa 💎</footer>

<script>
// بيانات افتراضية للسوبر أدمين والمدراء
let defaultAdmins = [
  {name:"Super Admin", phone:"01552402912", code:790707071, role:"superadmin"},
  {name:"admin1", phone:"01111111111", code:2001, role:"admin"},
  {name:"admin2", phone:"01111111112", code:2002, role:"admin"},
  {name:"admin3", phone:"01111111113", code:2003, role:"admin"},
  {name:"admin4", phone:"01111111114", code:2004, role:"admin"},
  {name:"admin5", phone:"01111111115", code:2005, role:"admin"},
];

let users=JSON.parse(localStorage.getItem('users')||"[]");

// إضافة المدراء والسوبر أدمين أول مرة فقط
if(!localStorage.getItem('adminsAdded')){
  users = users.concat(defaultAdmins);
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('adminsAdded', "yes");
}

let logged=JSON.parse(localStorage.getItem('loggedUser'));

function renderForms(){
  let html="";
  if(!logged){
    html+=`
    <h3>تسجيل مستخدم جديد</h3>
    <input type="text" id="newName" placeholder="الاسم الثلاثي">
    <input type="text" id="newPhone" placeholder="رقم الموبايل">
    <input type="number" id="newCode" placeholder="الكود (بين 2001 و 9999)">
    <button onclick="register()">تسجيل</button>

    <h3>أو تسجيل الدخول</h3>
    <input type="text" id="loginPhone" placeholder="رقم الموبايل">
    <input type="number" id="loginCode" placeholder="الكود">
    <button onclick="login()">دخول</button>
    `;
  }else{
    html+=`
    <h3>مرحبًا ${logged.name}</h3>
    <button class="logoutBtn" onclick="logout()">تسجيل خروج</button>
    `;
  }
  document.getElementById('formsContainer').innerHTML=html;
}

function register(){
  let name=document.getElementById('newName').value.trim();
  let phone=document.getElementById('newPhone').value.trim();
  let code=parseInt(document.getElementById('newCode').value.trim());

  let nameOk=/^[\u0600-\u06FF ]{7,}$/.test(name); // اسم عربي ثلاثي على الأقل 7 حروف مع مسافة
  let phoneOk=/^0\d{10}$/.test(phone);
  let codeOk=code>=2001 && code<=9999;

  if(!nameOk){ alert("❗ الاسم يجب أن يكون ثلاثي وبحروف عربية فقط."); return;}
  if(!phoneOk){ alert("❗ رقم الهاتف يجب أن يبدأ بـ 0 ويتكون من 11 رقم."); return;}
  if(!codeOk){ alert("❗ الكود يجب أن يكون بين 2001 و 9999."); return;}
  if(users.find(u=>u.phone===phone)){ alert("⚠️ هذا الرقم مسجل بالفعل."); return;}
  if(users.find(u=>u.code===code)){ alert("⚠️ هذا الكود مستخدم بالفعل."); return;}

  let user={name, phone, code, role:"user"};
  users.push(user);
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('loggedUser', JSON.stringify(user));
  alert("✅ تم التسجيل بنجاح.");
  location.href="myPurchases.html";
}

function login(){
  let phone=document.getElementById('loginPhone').value.trim();
  let code=parseInt(document.getElementById('loginCode').value.trim());
  let user=users.find(u=>u.phone===phone && u.code===code);

  if(user){
    localStorage.setItem('loggedUser', JSON.stringify(user));
    alert("✅ تم تسجيل الدخول بنجاح.");
    if(user.role==="superadmin" || user.role==="admin") location.href="admin.html";
    else location.href="myPurchases.html";
  }else{
    alert("❌ بيانات الدخول غير صحيحة.");
  }
}

function logout(){
  localStorage.removeItem('loggedUser');
  location.reload();
}

renderForms();
</script>

</body>
</html>
