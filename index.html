<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🏬 المتجر</title>
<style>
body { font-family:'Tahoma',sans-serif; margin:0; padding:0; text-align:center; background:#fff;}
header { background:#6c757d; color:#fff; padding:15px; font-size:22px;}
nav { background:#6c757d; color:#fff; padding:8px;}
nav a { color:#fff; text-decoration:none; margin:0 5px; font-size:14px;}
nav a:hover { text-decoration:underline;}
main { display:flex; flex-wrap:wrap; justify-content:center; margin:10px;}
.product { border:1px solid #ddd; border-radius:8px; padding:8px; margin:5px; width:45%; box-sizing:border-box;}
.product img { width:100%; max-height:120px; object-fit:cover; border-radius:6px;}
.product h4 { margin:5px 0; font-size:15px;}
.product p { margin:2px 0; font-size:13px; color:#555;}
button { margin-top:5px; padding:4px 10px; font-size:12px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer;}
button:hover { background:#555;}
footer { background:#f1f1f1; text-align:center; padding:8px; font-size:13px; color:#777; border-top:1px solid #ddd;}
</style>
</head>
<body>

<header>🏬 المتجر</header>

<nav>
  <a href="index.html">🏬 المتجر</a> |
  <a href="register.html">📝 التسجيل</a> |
  <a href="myPurchases.html">🛒 مشترياتي</a> |
  <a href="#" onclick="logoutUser()">🚪 تسجيل خروج</a>
</nav>

<main id="productList">
<!-- سيتم إدراج السلع هنا -->
</main>

<footer>💎 Powered by Almasa 💎</footer>

<script>
// تحميل السلع من localStorage
let products = JSON.parse(localStorage.getItem('products')||"[]");
let container = document.getElementById('productList');

if(products.length===0){
  container.innerHTML="<p>⚠️ لا توجد سلع متاحة حاليا</p>";
}else{
  let html="";
  products.forEach((p,idx)=>{
    let img = p.img && p.img.trim()!=="" ? p.img : "picture/empty.jpg";
    html+=`
    <div class="product">
      <img src="${img}" alt="${p.name}">
      <h4>${p.name}</h4>
      <p>السعر: ${p.price} جنيه</p>
      <p>${p.details||""}</p>
      <button onclick="buyProduct(${idx})">🛒 شراء</button>
    </div>`;
  });
  container.innerHTML=html;
}

// شراء سلعة
function buyProduct(idx){
  let loggedUser=JSON.parse(localStorage.getItem('loggedUser'));
  if(!loggedUser){
    alert("⚠️ يجب تسجيل الدخول أولاً");
    location.href="register.html";
    return;
  }
  let p=products[idx];
  let purchases=JSON.parse(localStorage.getItem('purchases')||"[]");
  purchases.push({ userCode:loggedUser.code, name:p.name, price:p.price, date:new Date().toLocaleString() });
  localStorage.setItem('purchases',JSON.stringify(purchases));

  let email=localStorage.getItem('adminEmail')||"mahmoudadelsaleh@gmail.com";
  alert(`✅ تم شراء ${p.name}\nسيتم إرسال إشعار إلى ${email}`);
}

// تسجيل خروج
function logoutUser(){
  localStorage.removeItem('loggedUser');
  alert("👋 تم تسجيل الخروج");
  location.href="register.html";
}

// التقاط تسجيل خروج في تبويبة أخرى
window.addEventListener('storage',function(e){
  if(e.key==='loggedUser' && e.newValue===null){
    alert("👋 تم تسجيل خروجك في تبويبة أخرى");
    location.href='register.html';
  }
});
</script>

</body>
</html>
